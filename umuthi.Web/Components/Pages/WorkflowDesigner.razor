@page "/workflow-designer/{workflowId:guid}"
@using umuthi.Web.Components
@using umuthi.Application.DTOs
@using umuthi.Application.Interfaces
@inject IWorkflowService WorkflowService
@inject ILogger<WorkflowDesigner> Logger
@rendermode InteractiveServer

<PageTitle>Workflow Designer - @(workflow?.Name ?? "Loading...")</PageTitle>

@if (workflow == null)
{
    <div class="d-flex justify-content-center align-items-center" style="height: 100vh;">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading workflow...</p>
        </div>
    </div>
}
else
{
    <div style="height: 100vh; display: flex; flex-direction: column;">
        <!-- Header -->
        <div style="padding: 1rem; background: white; border-bottom: 1px solid #dee2e6; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">@workflow.Name</h2>
                    <p class="text-muted mb-0">@workflow.Description</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary">
                        <i class="bi bi-save"></i> Save
                    </button>
                    <button class="btn btn-outline-secondary">
                        <i class="bi bi-play"></i> Test Run
                    </button>
                    <a href="/workflows" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Workflows
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Canvas -->
        <div style="flex: 1;">
            <WorkflowCanvas>
                <!-- Sample workflow nodes using the new WorkflowNode component -->
                @foreach (var node in workflowNodes)
                {
                    <WorkflowNode Id="@node.Id"
                                  Label="@node.Label"
                                  Description="@node.Description"
                                  NodeType="@node.NodeType"
                                  PositionX="@node.PositionX"
                                  PositionY="@node.PositionY"
                                  IsSelected="@(selectedNodeId == node.Id)"
                                  HasError="@node.HasError"
                                  Status="@node.Status"
                                  OnNodeClicked="OnNodeClicked"
                                  OnNodeDragStart="OnNodeDragStart"
                                  OnNodeDrag="OnNodeDrag"
                                  OnNodeDragEnd="OnNodeDragEnd" />
                }

                <!-- Connection lines would be rendered here -->
                <svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;">
                    <!-- Sample connections -->
                    <line x1="200" y1="150" x2="300" y2="290" stroke="#8b949e" stroke-width="2" marker-end="url(#arrowhead)" />
                    <line x1="350" y1="350" x2="250" y2="430" stroke="#8b949e" stroke-width="2" marker-end="url(#arrowhead)" />
                    <line x1="250" y1="470" x2="350" y2="580" stroke="#8b949e" stroke-width="2" marker-end="url(#arrowhead)" />
                    
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                                refX="10" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#8b949e" />
                        </marker>
                    </defs>
                </svg>
            </WorkflowCanvas>
        </div>
    </div>
}

@code {
    [Parameter] public Guid WorkflowId { get; set; }
    
    private WorkflowDto? workflow;
    private string? selectedNodeId;
    private List<WorkflowNodeModel> workflowNodes = new();
    
    protected override async Task OnInitializedAsync()
    {
        await LoadWorkflow();
        InitializeSampleNodes();
    }
    
    private async Task LoadWorkflow()
    {
        try
        {
            workflow = await WorkflowService.GetWorkflowByIdAsync(WorkflowId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading workflow {WorkflowId}", WorkflowId);
        }
    }

    private void InitializeSampleNodes()
    {
        workflowNodes = new List<WorkflowNodeModel>
        {
            new() 
            { 
                Id = "email-1", 
                Label = "Email Trigger", 
                Description = "Trigger on new email",
                NodeType = WorkflowNode.NodeTypeCategory.Email,
                PositionX = 100, 
                PositionY = 100 
            },
            new() 
            { 
                Id = "ai-1", 
                Label = "AI Processing", 
                Description = "Process text with AI",
                NodeType = WorkflowNode.NodeTypeCategory.AI,
                PositionX = 300, 
                PositionY = 250,
                Status = WorkflowNode.NodeStatus.Running
            },
            new() 
            { 
                Id = "router-1", 
                Label = "Decision Router", 
                Description = "Route based on condition",
                NodeType = WorkflowNode.NodeTypeCategory.Router,
                PositionX = 150, 
                PositionY = 400 
            },
            new() 
            { 
                Id = "integration-1", 
                Label = "API Integration", 
                Description = "Call external API",
                NodeType = WorkflowNode.NodeTypeCategory.Integration,
                PositionX = 350, 
                PositionY = 550,
                HasError = true
            },
            new() 
            { 
                Id = "utility-1", 
                Label = "Data Transform", 
                Description = "Transform data format",
                NodeType = WorkflowNode.NodeTypeCategory.Utility,
                PositionX = 500, 
                PositionY = 300,
                Status = WorkflowNode.NodeStatus.Completed
            }
        };
    }

    private Task OnNodeClicked(WorkflowNode.WorkflowNodeEventArgs args)
    {
        selectedNodeId = args.NodeId;
        StateHasChanged();
        Logger.LogInformation("Node clicked: {NodeId}", args.NodeId);
        return Task.CompletedTask;
    }

    private Task OnNodeDragStart(WorkflowNode.WorkflowNodeEventArgs args)
    {
        Logger.LogInformation("Node drag start: {NodeId} at ({X}, {Y})", args.NodeId, args.X, args.Y);
        return Task.CompletedTask;
    }

    private Task OnNodeDrag(WorkflowNode.WorkflowNodeEventArgs args)
    {
        var node = workflowNodes.FirstOrDefault(n => n.Id == args.NodeId);
        if (node != null)
        {
            node.PositionX = args.X;
            node.PositionY = args.Y;
            StateHasChanged();
        }
        return Task.CompletedTask;
    }

    private Task OnNodeDragEnd(WorkflowNode.WorkflowNodeEventArgs args)
    {
        Logger.LogInformation("Node drag end: {NodeId} at ({X}, {Y})", args.NodeId, args.X, args.Y);
        // Here you would typically save the new position to the backend
        return Task.CompletedTask;
    }

    private class WorkflowNodeModel
    {
        public string Id { get; set; } = "";
        public string Label { get; set; } = "";
        public string Description { get; set; } = "";
        public WorkflowNode.NodeTypeCategory NodeType { get; set; } = WorkflowNode.NodeTypeCategory.Utility;
        public double PositionX { get; set; } = 0;
        public double PositionY { get; set; } = 0;
        public bool HasError { get; set; } = false;
        public WorkflowNode.NodeStatus Status { get; set; } = WorkflowNode.NodeStatus.None;
    }
}